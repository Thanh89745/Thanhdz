<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>MQTT Image Toggle</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  body{margin:0;padding:20px;background:#111;color:#fff;text-align:center;font-family:Arial}
  .img-container{position:relative;display:inline-block;max-width:90vw}
  .main{width:100%;border-radius:14px;box-shadow:0 0 20px rgba(0,0,0,.6);cursor:pointer;transition:filter .3s}
  .bw{filter:grayscale(100%)}
  .logo{position:absolute;bottom:8px;right:8px;width:50px;height:50px;border-radius:8px;box-shadow:0 0 8px rgba(0,0,0,.5);filter:grayscale(100%);transition:.3s;cursor:pointer}
  .color{filter:grayscale(0%)}
</style>
</head>
<body>

<div class="img-container">
  <img id="pic" class="main bw" src="https://i.pinimg.com/736x/cc/45/b3/cc45b3d3731a69ff4cc9bc93ac512214.jpg">
  <img id="logo" class="logo" src="https://i.pinimg.com/736x/37/99/a0/3799a010c4b97d130a124d9a6d0e2d42.jpg">
</div>

<script>
let client, isOn=false, lastMsg="", count=0, ignoreUntil=0;
const pic=document.getElementById("pic"), logo=document.getElementById("logo");

client = mqtt.connect('wss://mqtt-dashboard.com:8884/mqtt');
client.on('connect', () => { logo.classList.add("color"); client.subscribe(["esp32/TBT/status","esp32/TBT/msg"]); });
client.on('error', () => logo.classList.remove("color"));
client.on('message', (t,m) => {
  let msg = m.toString().trim();
  if(t==="esp32/TBT/status"){
    if(Date.now() > ignoreUntil && isOn !== (msg==="on")){
      isOn = (msg==="on");
      pic.classList.toggle("bw",!isOn);
    }
    lastMsg = msg;
    count = (count%10) + 1;
  }
});

pic.onclick=()=>{
  isOn=!isOn;
  pic.classList.toggle("bw",!isOn);
  ignoreUntil = Date.now() + 1000; // bỏ qua phản hồi 300ms
  if(client.connected) client.publish("esp32/TBT", isOn ? "on" : "off");
};

logo.onclick=()=>alert(`Đã nhận ${count} tin nhắn.\nNội dung cuối: ${lastMsg||"Chưa có"}`);
</script>
</body>
</html>
