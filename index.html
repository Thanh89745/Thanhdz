<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMART MODULE</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 15px;
      background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://4kwallpapers.com/images/walls/thumbs_3t/23027.jpg') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #fff;
    }
    .header-container {
      display: flex;
      justify-content: flex-end;
      width: 100%;
      max-width: 600px;
      margin-bottom: 10px;
    }
    .icon-container {
      display: flex;
      gap: 12px;
    }
    #settingsIcon, #clockIcon, #albumIcon {
      font-size: 24px;
      cursor: pointer;
      color: #fff;
      transition: transform 0.3s ease, color 0.3s ease;
    }
    #settingsIcon:hover, #clockIcon:hover, #albumIcon:hover {
      color: #60a5fa;
      transform: scale(1.2);
    }
    h1 {
      color: #fff;
      font-size: 24px;
      font-weight: 700;
      margin: 0 auto 10px;
      text-align: center;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 300px;
    }
    /* Device Name Input */
    .device-name-container {
      margin: 10px 0;
    }
    #deviceName {
      padding: 8px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      width: 100%;
      max-width: 200px;
      text-align: center;
      background: #fff;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    #deviceName:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 5px rgba(96, 165, 250, 0.5);
    }
    /* Button Styling */
    .toggle-button {
      position: relative;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 3px solid #9ca3af;
      background: radial-gradient(circle, #f3f4f6 0%, #d1d5db 50%, #9ca3af 100%);
      color: #1e3a8a;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.2), 0 3px 6px rgba(0,0,0,0.3), 0 0 8px rgba(0,0,0,0.1);
      filter: brightness(1);
      transition: all 0.3s ease;
      outline: none;
    }
    .toggle-button.on {
      border-color: #60a5fa;
      background: radial-gradient(circle, #e0e7ff 0%, #93c5fd 50%, #60a5fa 100%);
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.2), 0 0 10px #60a5fa;
      filter: brightness(1.15);
    }
    .toggle-button:active {
      box-shadow: inset 0 4px 8px rgba(0,0,0,0.4);
      transform: scale(0.95);
    }
    .toggle-button.listening::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(96, 165, 250, 0.3);
      animation: ripple 1.2s infinite;
      transform: translate(-50%, -50%);
    }
    @keyframes ripple {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.6;
      }
      100% {
        transform: translate(-50%, -50%) scale(2.2);
        opacity: 0;
      }
    }
    .control-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      width: 100%;
      max-width: 600px;
    }
    .control-inner {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      width: 100%;
      justify-content: center;
    }
    .frame {
      display: none;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      padding: 15px;
      max-width: 350px;
      width: 100%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      position: relative;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .frame-close {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 20px;
      cursor: pointer;
      color: #4b5563;
      transition: color 0.3s ease;
    }
    .frame-close:hover {
      color: #ef4444;
    }
    #datetime {
      font-size: 16px;
      color: #1e3a8a;
      font-weight: 500;
      margin-bottom: 12px;
    }
    .timer-container {
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    .timer-container input, .timer-container select, .timer-container button {
      padding: 8px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      transition: all 0.3s ease;
    }
    .timer-container input:focus, .timer-container select:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 5px rgba(96, 165, 250, 0.5);
    }
    .timer-container button {
      background: #60a5fa;
      color: white;
      cursor: pointer;
      font-weight: 500;
    }
    .timer-container button:hover {
      background: #3b82f6;
    }
    .timer-container .clear-timers {
      background: #ef4444;
    }
    .timer-container .clear-timers:hover {
      background: #dc2626;
    }
    .history-container {
      text-align: left;
    }
    .history-container h3 {
      color: #1e3a8a;
      font-size: 16px;
      margin: 0 0 8px;
    }
    .history-container ul {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 180px;
      overflow-y: auto;
    }
    .history-container li {
      background: #f8fafc;
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
      font-size: 13px;
      color: #4b5563;
      box-shadow: 0 2px 3px rgba(0,0,0,0.05);
    }
    .history-container button {
      background: #ef4444;
      color: white;
      padding: 8px;
      margin-top: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      font-weight: 500;
      transition: background 0.3s ease;
    }
    .history-container button:hover {
      background: #dc2626;
    }
    /* Modal Styling */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 10px;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease;
    }
    .modal-content h3 {
      color: #1e3a8a;
      font-size: 18px;
      margin: 0 0 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    .modal-content ul {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 60vh;
      overflow-y: auto;
    }
    .modal-content li {
      padding: 8px;
      margin: 5px 0;
      font-size: 13px;
      color: #4b5563;
      border-bottom: 1px solid #e5e7eb;
    }
    .modal-content input[type="file"],
    .modal-content input[type="text"] {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }
    .modal-content input[type="file"]:focus,
    .modal-content input[type="text"]:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 5px rgba(96, 165, 250, 0.5);
    }
    .modal-content button {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s ease;
    }
    .modal-content .apply-button {
      background: #60a5fa;
      color: white;
    }
    .modal-content .apply-button:hover {
      background: #3b82f6;
    }
    .close {
      float: right;
      font-size: 20px;
      cursor: pointer;
      color: #4b5563;
      transition: color 0.3s ease;
    }
    .close:hover {
      color: #ef4444;
    }
    /* Responsive Design */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      .header-container {
        justify-content: flex-end;
        margin-bottom: 5px;
      }
      h1 {
        font-size: 20px;
        max-width: 280px;
      }
      #settingsIcon, #clockIcon, #albumIcon {
        font-size: 20px;
      }
      .control-inner {
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }
      .toggle-button {
        width: 50px;
        height: 50px;
        font-size: 14px;
        border-width: 2px;
      }
      .toggle-button.listening::after {
        width: 50px;
        height: 50px;
      }
      .frame {
        max-width: 100%;
        padding: 12px;
      }
      #deviceName {
        max-width: 280px;
        font-size: 13px;
        padding: 6px;
      }
      .timer-container input, .timer-container select, .timer-container button {
        font-size: 13px;
        padding: 6px;
      }
      .modal-content {
        max-width: 90%;
        padding: 12px;
      }
      .modal-content h3 {
        font-size: 16px;
      }
      .modal-content li {
        font-size: 12px;
      }
      .modal-content input[type="file"],
      .modal-content input[type="text"] {
        font-size: 13px;
        padding: 6px;
      }
      .modal-content button {
        font-size: 13px;
        padding: 6px;
      }
    }
  </style>
</head>
<body>
  <div class="header-container">
    <div class="icon-container">
      <span id="clockIcon" onclick="toggleFrame()" title="H·∫πn gi·ªù v√† l·ªãch s·ª≠">‚è∞</span>
      <span id="settingsIcon" onclick="openModal()" title="L·ªãch s·ª≠ ƒë·∫ßy ƒë·ªß">‚öôÔ∏è</span>
      <span id="albumIcon" onclick="openBackgroundModal()" title="Thay ƒë·ªïi ·∫£nh n·ªÅn">üì∑</span>
    </div>
  </div>
  <div class="control-container">
    <h1 id="title">SMART MODULE</h1>
    <div class="device-name-container">
      <input type="text" id="deviceName" placeholder="T√™n thi·∫øt b·ªã" value="Thi·∫øt b·ªã">
    </div>
    <div class="control-inner">
      <button class="toggle-button" id="controlButton">OFF</button>
      <div class="frame" id="frame">
        <span class="frame-close" onclick="hideFrame()">√ó</span>
        <div id="datetime"></div>
        <div class="timer-container">
          <input type="datetime-local" id="timerInput">
          <select id="timerAction">
            <option value="1o">B·∫≠t</option>
            <option value="1f">T·∫Øt</option>
          </select>
          <button onclick="setTimer()">H·∫πn gi·ªù</button>
          <button class="clear-timers" onclick="clearTimers()">X√≥a l·ªãch h·∫πn gi·ªù</button>
        </div>
        <div class="history-container">
          <h3>L·ªãch s·ª≠ h·∫πn gi·ªù</h3>
          <ul id="historyList"></ul>
          <button onclick="clearTimerHistory()">X√≥a l·ªãch s·ª≠ h·∫πn gi·ªù</button>
        </div>
      </div>
    </div>
  </div>
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">√ó</span>
      <h3>L·ªãch s·ª≠ ƒë·∫ßy ƒë·ªß</h3>
      <ul id="fullHistoryList"></ul>
    </div>
  </div>
  <div id="backgroundModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeBackgroundModal()">√ó</span>
      <h3>Thay ƒë·ªïi ·∫£nh n·ªÅn</h3>
      <input type="file" id="backgroundImageInput" accept="image/jpeg,image/png">
      <input type="text" id="backgroundUrlInput" placeholder="Nh·∫≠p URL ·∫£nh (VD: https://example.com/image.jpg)">
      <button class="apply-button" onclick="applyBackground()">√Åp d·ª•ng</button>
    </div>
  </div>

<script>
  let client;
  let timers = [];
  let isListening = false;
  let recognition;

  function connectMQTT() {
    client = mqtt.connect('wss://mqtt-dashboard.com:8884/mqtt');
    const title = document.getElementById("title");

    client.on('connect', () => {
      title.style.color = "#22c55e";
      client.subscribe("esp32/NVH/status", (err) => {
        if (!err) {
          client.publish("esp32/NVH", "get_status");
        }
      });
    });

    client.on('error', () => {
      title.style.color = "#ef4444";
    });

    client.on('message', (topic, message) => {
      const msg = message.toString().trim();
      const button = document.getElementById("controlButton");
      if (topic === "esp32/NVH/status") {
        button.classList.toggle("on", msg === "1o");
        button.textContent = msg === "1o" ? "ON" : "OFF";
        addFullHistory(`Tr·∫°ng th√°i t·ª´ ESP32: ${msg === "1o" ? "B·∫≠t" : "T·∫Øt"}`);
      }
    });
  }

  function setupButton() {
    const button = document.getElementById("controlButton");
    let pressTimer;

    button.addEventListener("mousedown", () => {
      pressTimer = setTimeout(() => {
        if (!isListening) {
          startVoiceRecognition();
          button.classList.add("listening");
        }
      }, 2000);
    });

    button.addEventListener("mouseup", () => {
      clearTimeout(pressTimer);
      if (!isListening) {
        if (client && client.connected) {
          const isOn = button.classList.contains("on");
          const action = isOn ? "1f" : "1o";
          client.publish("esp32/NVH", action);
          button.classList.toggle("on");
          button.textContent = isOn ? "OFF" : "ON";
          addFullHistory(`C√¥ng t·∫Øc th·ªß c√¥ng: ${action === "1o" ? "B·∫≠t" : "T·∫Øt"}`);
        }
      }
    });

    button.addEventListener("mouseleave", () => {
      clearTimeout(pressTimer);
    });
  }

  function setupDeviceName() {
    const deviceNameInput = document.getElementById("deviceName");
    const savedName = localStorage.getItem("deviceName") || "Thi·∫øt b·ªã";
    deviceNameInput.value = savedName;
    deviceNameInput.addEventListener("change", () => {
      localStorage.setItem("deviceName", deviceNameInput.value.trim());
    });
  }

  function startVoiceRecognition() {
    if (isListening) return;
    isListening = true;
    const deviceName = document.getElementById("deviceName").value.trim().toLowerCase();
    if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
      alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i!");
      stopVoiceRecognition();
      return;
    }
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "vi-VN";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript.toLowerCase();
      const button = document.getElementById("controlButton");
      if (transcript.includes("m·ªü " + deviceName) || transcript.includes("b·∫≠t " + deviceName)) {
        if (client && client.connected) {
          client.publish("esp32/NVH", "1o");
          button.classList.add("on");
          button.textContent = "ON";
          addFullHistory(`ƒêi·ªÅu khi·ªÉn b·∫±ng gi·ªçng n√≥i: B·∫≠t (${transcript})`);
        }
      } else if (transcript.includes("t·∫Øt " + deviceName)) {
        if (client && client.connected) {
          client.publish("esp32/NVH", "1f");
          button.classList.remove("on");
          button.textContent = "OFF";
          addFullHistory(`ƒêi·ªÅu khi·ªÉn b·∫±ng gi·ªçng n√≥i: T·∫Øt (${transcript})`);
        }
      }
      stopVoiceRecognition();
    };

    recognition.onerror = (event) => {
      console.error("Voice recognition error:", event.error);
      stopVoiceRecognition();
    };

    recognition.onend = () => {
      stopVoiceRecognition();
    };

    recognition.start();
  }

  function stopVoiceRecognition() {
    if (recognition) {
      recognition.stop();
      recognition = null;
    }
    isListening = false;
    const button = document.getElementById("controlButton");
    button.classList.remove("listening");
  }

  function updateDateTime() {
    const now = new Date();
    const vietnamTime = new Date(now.getTime() + 7 * 60 * 60 * 1000);
    const hours = vietnamTime.getUTCHours().toString().padStart(2, '0');
    const minutes = vietnamTime.getUTCMinutes().toString().padStart(2, '0');
    const seconds = vietnamTime.getUTCSeconds().toString().padStart(2, '0');
    const day = vietnamTime.getUTCDate().toString().padStart(2, '0');
    const month = (vietnamTime.getUTCMonth() + 1).toString().padStart(2, '0');
    const year = vietnamTime.getUTCFullYear();
    const datetimeStr = `${hours}:${minutes}:${seconds}, ${day}/${month}/${year}`;
    document.getElementById("datetime").textContent = datetimeStr;
  }

  function setTimer() {
    const timerInput = document.getElementById("timerInput").value;
    const action = document.getElementById("timerAction").value;
    if (!timerInput) {
      alert("Vui l√≤ng ch·ªçn th·ªùi gian!");
      return;
    }
    const timerTime = new Date(timerInput);
    if (timerTime <= new Date()) {
      alert("Th·ªùi gian ph·∫£i ·ªü t∆∞∆°ng lai!");
      return;
    }
    timers.push({ time: timerTime, action });
    addHistory(`H·∫πn gi·ªù ${action === "1o" ? "B·∫≠t" : "T·∫Øt"} l√∫c ${formatDateTime(timerTime)}`);
    addFullHistory(`H·∫πn gi·ªù ${action === "1o" ? "B·∫≠t" : "T·∫Øt"} l√∫c ${formatDateTime(timerTime)}`);
    saveTimers();
    document.getElementById("timerInput").value = "";
  }

  function checkTimers() {
    const now = new Date();
    timers = timers.filter(timer => {
      if (timer.time <= now) {
        if (client && client.connected) {
          client.publish("esp32/NVH", timer.action);
          addHistory(`Th·ª±c hi·ªán h·∫πn gi·ªù: ${timer.action === "1o" ? "B·∫≠t" : "T·∫Øt"}`);
          addFullHistory(`Th·ª±c hi·ªán h·∫πn gi·ªù: ${timer.action === "1o" ? "B·∫≠t" : "T·∫Øt"}`);
        }
        return false;
      }
      return true;
    });
    saveTimers();
  }

  function addHistory(message) {
    const now = new Date();
    const vietnamTime = new Date(now.getTime() + 7 * 60 * 60 * 1000);
    const timeStr = formatDateTime(vietnamTime);
    const historyList = document.getElementById("historyList");
    const li = document.createElement("li");
    li.textContent = `[${timeStr}] ${message}`;
    historyList.prepend(li);
    saveTimerHistory(`[${timeStr}] ${message}`);
    while (historyList.children.length > 5) {
      historyList.removeChild(historyList.lastChild);
    }
  }

  function addFullHistory(message) {
    const now = new Date();
    const vietnamTime = new Date(now.getTime() + 7 * 60 * 60 * 1000);
    const timeStr = formatDateTime(vietnamTime);
    const fullHistoryList = document.getElementById("fullHistoryList");
    const li = document.createElement("li");
    li.textContent = `[${timeStr}] ${message}`;
    fullHistoryList.prepend(li);
    saveFullHistory(`[${timeStr}] ${message}`);
    while (fullHistoryList.children.length > 5) {
      fullHistoryList.removeChild(fullHistoryList.lastChild);
    }
  }

  function formatDateTime(date) {
    const hours = date.getUTCHours().toString().padStart(2, '0');
    const minutes = date.getUTCMinutes().toString().padStart(2, '0');
    const seconds = date.getUTCSeconds().toString().padStart(2, '0');
    const day = date.getUTCDate().toString().padStart(2, '0');
    const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
    const year = date.getUTCFullYear();
    return `${hours}:${minutes}:${seconds}, ${day}/${month}/${year}`;
  }

  function saveTimers() {
    localStorage.setItem("timers", JSON.stringify(timers.map(t => ({
      time: t.time.toISOString(),
      action: t.action
    }))));
  }

  function loadTimers() {
    const savedTimers = localStorage.getItem("timers");
    if (savedTimers) {
      timers = JSON.parse(savedTimers).map(t => ({
        time: new Date(t.time),
        action: t.action
      }));
      timers = timers.filter(t => t.time > new Date());
    }
  }

  function saveTimerHistory(message) {
    let history = JSON.parse(localStorage.getItem("timerHistory") || "[]");
    history.unshift(message);
    if (history.length > 5) history = history.slice(0, 5);
    localStorage.setItem("timerHistory", JSON.stringify(history));
  }

  function saveFullHistory(message) {
    let history = JSON.parse(localStorage.getItem("fullHistory") || "[]");
    history.unshift(message);
    if (history.length > 5) history = history.slice(0, 5);
    localStorage.setItem("fullHistory", JSON.stringify(history));
  }

  function loadTimerHistory() {
    const history = JSON.parse(localStorage.getItem("timerHistory") || "[]");
    const historyList = document.getElementById("historyList");
    history.reverse().forEach(message => {
      const li = document.createElement("li");
      li.textContent = message;
      historyList.appendChild(li);
    });
  }

  function loadFullHistory() {
    const history = JSON.parse(localStorage.getItem("fullHistory") || "[]");
    const fullHistoryList = document.getElementById("fullHistoryList");
    fullHistoryList.innerHTML = "";
    history.reverse().forEach(message => {
      const li = document.createElement("li");
      li.textContent = message;
      fullHistoryList.appendChild(li);
    });
  }

  function clearTimerHistory() {
    localStorage.removeItem("timerHistory");
    const historyList = document.getElementById("historyList");
    historyList.innerHTML = "";
    addFullHistory("X√≥a l·ªãch s·ª≠ h·∫πn gi·ªù");
  }

  function clearTimers() {
    timers = [];
    localStorage.removeItem("timers");
    addHistory("X√≥a t·∫•t c·∫£ l·ªãch h·∫πn gi·ªù");
    addFullHistory("X√≥a t·∫•t c·∫£ l·ªãch h·∫πn gi·ªù");
  }

  function toggleFrame() {
    const frame = document.getElementById("frame");
    frame.style.display = frame.style.display === "block" ? "none" : "block";
  }

  function hideFrame() {
    document.getElementById("frame").style.display = "none";
  }

  function openModal() {
    document.getElementById("historyModal").style.display = "flex";
    loadFullHistory();
  }

  function closeModal() {
    document.getElementById("historyModal").style.display = "none";
  }

  function openBackgroundModal() {
    document.getElementById("backgroundModal").style.display = "flex";
    document.getElementById("backgroundImageInput").value = "";
    document.getElementById("backgroundUrlInput").value = "";
  }

  function closeBackgroundModal() {
    document.getElementById("backgroundModal").style.display = "none";
  }

  function applyBackground() {
    const fileInput = document.getElementById("backgroundImageInput");
    const urlInput = document.getElementById("backgroundUrlInput").value.trim();
    const defaultBackground = "https://4kwallpapers.com/images/walls/thumbs_3t/23027.jpg";

    if (fileInput.files && fileInput.files[0]) {
      const file = fileInput.files[0];
      if (!file.type.match("image/jpeg|image/png")) {
        alert("Vui l√≤ng ch·ªçn file ·∫£nh JPEG ho·∫∑c PNG!");
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        document.body.style.background = `linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('${e.target.result}') no-repeat center center fixed`;
        document.body.style.backgroundSize = "cover";
        localStorage.setItem("backgroundImage", e.target.result);
        closeBackgroundModal();
      };
      reader.readAsDataURL(file);
    } else if (urlInput) {
      const img = new Image();
      img.onload = function() {
        document.body.style.background = `linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('${urlInput}') no-repeat center center fixed`;
        document.body.style.backgroundSize = "cover";
        localStorage.setItem("backgroundImage", urlInput);
        closeBackgroundModal();
      };
      img.onerror = function() {
        alert("URL ·∫£nh kh√¥ng h·ª£p l·ªá! Vui l√≤ng ki·ªÉm tra l·∫°i.");
      };
      img.src = urlInput;
    } else {
      document.body.style.background = `linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('${defaultBackground}') no-repeat center center fixed`;
      document.body.style.backgroundSize = "cover";
      localStorage.removeItem("backgroundImage");
      closeBackgroundModal();
    }
  }

  function loadBackground() {
    const savedBackground = localStorage.getItem("backgroundImage");
    const defaultBackground = "https://4kwallpapers.com/images/walls/thumbs_3t/23027.jpg";
    if (savedBackground) {
      document.body.style.background = `linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('${savedBackground}') no-repeat center center fixed`;
      document.body.style.backgroundSize = "cover";
    }
  }

  window.onload = () => {
    loadBackground();
    connectMQTT();
    setupButton();
    setupDeviceName();
    updateDateTime();
    setInterval(updateDateTime, 1000);
    loadTimers();
    loadTimerHistory();
    setInterval(checkTimers, 1000);
  };
</script>
</body>
</html>